<!--
  Copyright (c) 2016-2021 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Iter8 is the release engineering platform for Kubernetes applications and ML models. Quick start in 5 mins."><meta name=author content="Srinivasan Parthasarathy"><link href=https://iter8.tools/0.7/tutorials/istio/gitops/argocd/ rel=canonical><link rel=icon href=../../../../images/favicon.png><meta name=generator content="mkdocs-1.1, mkdocs-material-7.1.8"><title>Argo CD + Istio - Iter8</title><link rel=stylesheet href=../../../../assets/stylesheets/main.ca7ac06f.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.f1a3b89f.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-152813895-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:site_name content=Iter8><meta property=og:title content="SLO validation, A/B testing, and progressive rollouts"><meta property=og:description content="Iter8 is the release engineering platform for Kubernetes applications and ML models. Quick start in 5 mins."><meta property=og:url content=https://iter8.tools><meta property=og:image content=https://iter8.tools/0.7/images/slack-image.png><!-- Twitter meta tags --><meta name=twitter:card content=summary_large_image><meta name=twitter:url content=https://iter8.tools><meta name=twitter:creator content="Srinivasan Parthasarathy"><meta name=twitter:title content="SLO validation, A/B testing, and progressive rollouts"><meta name=twitter:description content="Iter8 is the release engineering platform for Kubernetes applications and ML models. Quick start in 5 mins."><meta name=twitter:image content=https://iter8.tools/0.7/images/slack-image.png><meta name=twitter:label1 value="K8s stacks"><meta name=twitter:data1 value="KFServing, Seldon, Knative, Istio, ..."><!-- Extra stylesheets --><link rel=stylesheet href=../../../../stylesheets/main.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <script>function __prefix(e){return new URL("../../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#gitops-with-argo-cd class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=Iter8 class="md-header__button md-logo" aria-label=Iter8 data-md-component=logo> <img src=../../../../images/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Iter8 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Argo CD + Istio </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=pink data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/iter8-tools/iter8/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> iter8-tools/iter8 </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../../concepts/whatisiter8/ class=md-tabs__link> Concepts </a> </li> <li class=md-tabs__item> <a href=../../../../getting-started/install/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../../kfserving/testing-strategies/hybrid/ class="md-tabs__link md-tabs__link--active"> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../../../metrics/using-metrics/ class=md-tabs__link> Metrics </a> </li> <li class=md-tabs__item> <a href=../../../../reference/experiment/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../../../contributing/overview/ class=md-tabs__link> Contributing </a> </li> <li class=md-tabs__item> <a href=../../../../roadmap/ class=md-tabs__link> Roadmap </a> </li> <li class=md-tabs__item> <a href=../../../../news/ class=md-tabs__link> News </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=Iter8 class="md-nav__button md-logo" aria-label=Iter8 data-md-component=logo> <img src=../../../../images/logo.svg alt=logo> </a> Iter8 </label> <div class=md-nav__source> <a href=https://github.com/iter8-tools/iter8/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> iter8-tools/iter8 </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Concepts <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Concepts data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../concepts/whatisiter8/ class=md-nav__link> What is Iter8? </a> </li> <li class=md-nav__item> <a href=../../../../concepts/buildingblocks/ class=md-nav__link> Experiment building blocks </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Getting Started <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Getting Started" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/install/ class=md-nav__link> Install Iter8 </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/help/ class=md-nav__link> Get help </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3> Quick start tutorials <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Quick start tutorials" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Quick start tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_1 type=checkbox id=__nav_3_3_1> <label class=md-nav__link for=__nav_3_3_1> KFServing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=KFServing data-md-level=3> <label class=md-nav__title for=__nav_3_3_1> <span class="md-nav__icon md-icon"></span> KFServing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/kfserving/tutorial/ class=md-nav__link> A/B testing </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/kfserving/platform-setup/ class=md-nav__link> Platform setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_2 type=checkbox id=__nav_3_3_2> <label class=md-nav__link for=__nav_3_3_2> Seldon <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Seldon data-md-level=3> <label class=md-nav__title for=__nav_3_3_2> <span class="md-nav__icon md-icon"></span> Seldon </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/seldon/tutorial/ class=md-nav__link> Hybrid (A/B + SLOs) testing </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/seldon/platform-setup/ class=md-nav__link> Platform setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_3 type=checkbox id=__nav_3_3_3> <label class=md-nav__link for=__nav_3_3_3> Knative <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Knative data-md-level=3> <label class=md-nav__title for=__nav_3_3_3> <span class="md-nav__icon md-icon"></span> Knative </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/knative/tutorial/ class=md-nav__link> Hybrid (A/B + SLOs) testing </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/knative/platform-setup/ class=md-nav__link> Platform setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_4 type=checkbox id=__nav_3_3_4> <label class=md-nav__link for=__nav_3_3_4> Istio <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Istio data-md-level=3> <label class=md-nav__title for=__nav_3_3_4> <span class="md-nav__icon md-icon"></span> Istio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/istio/tutorial/ class=md-nav__link> Hybrid (A/B + SLOs) testing </a> </li> <li class=md-nav__item> <a href=../../../../getting-started/quick-start/istio/platform-setup/ class=md-nav__link> Platform setup </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Tutorials <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Tutorials data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> KFServing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=KFServing data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> KFServing </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1_1 type=checkbox id=__nav_4_1_1> <label class=md-nav__link for=__nav_4_1_1> Testing strategies <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Testing strategies" data-md-level=3> <label class=md-nav__title for=__nav_4_1_1> <span class="md-nav__icon md-icon"></span> Testing strategies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../kfserving/testing-strategies/hybrid/ class=md-nav__link> Hybrid (A/B + SLOs) testing </a> </li> <li class=md-nav__item> <a href=../../../kfserving/testing-strategies/ab/ class=md-nav__link> A/B testing (quick start) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1_2 type=checkbox id=__nav_4_1_2> <label class=md-nav__link for=__nav_4_1_2> Rollout strategies <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Rollout strategies" data-md-level=3> <label class=md-nav__title for=__nav_4_1_2> <span class="md-nav__icon md-icon"></span> Rollout strategies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../kfserving/rollout-strategies/progressive/ class=md-nav__link> Progressive traffic shift </a> </li> <li class=md-nav__item> <a href=../../../kfserving/rollout-strategies/fixed-split/ class=md-nav__link> Fixed-%-split </a> </li> <li class=md-nav__item> <a href=../../../kfserving/rollout-strategies/session-affinity/ class=md-nav__link> Session affinity </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Knative <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Knative data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Knative </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2_1 type=checkbox id=__nav_4_2_1> <label class=md-nav__link for=__nav_4_2_1> Testing strategies <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Testing strategies" data-md-level=3> <label class=md-nav__title for=__nav_4_2_1> <span class="md-nav__icon md-icon"></span> Testing strategies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../knative/testing-strategies/slovalidationprogressive/ class=md-nav__link> SLO validation </a> </li> <li class=md-nav__item> <a href=../../../knative/testing-strategies/conformance/ class=md-nav__link> SLO validation (builtin metrics) </a> </li> <li class=md-nav__item> <a href=../../../knative/testing-strategies/ab/ class=md-nav__link> A/B testing (quick start) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2_2 type=checkbox id=__nav_4_2_2> <label class=md-nav__link for=__nav_4_2_2> Rollout strategies <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Rollout strategies" data-md-level=3> <label class=md-nav__title for=__nav_4_2_2> <span class="md-nav__icon md-icon"></span> Rollout strategies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../knative/rollout-strategies/progressive/ class=md-nav__link> Progressive traffic shift </a> </li> <li class=md-nav__item> <a href=../../../knative/rollout-strategies/fixed-split/ class=md-nav__link> Fixed-%-split </a> </li> <li class=md-nav__item> <a href=../../../knative/rollout-strategies/user-segmentation/ class=md-nav__link> User segmentation </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3 checked> <label class=md-nav__link for=__nav_4_3> Istio <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Istio data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Istio </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_1 type=checkbox id=__nav_4_3_1> <label class=md-nav__link for=__nav_4_3_1> Testing strategies <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Testing strategies" data-md-level=3> <label class=md-nav__title for=__nav_4_3_1> <span class="md-nav__icon md-icon"></span> Testing strategies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../testing-strategies/slovalidation/ class=md-nav__link> SLO validation </a> </li> <li class=md-nav__item> <a href=../../testing-strategies/conformance/ class=md-nav__link> SLO validation (single version) </a> </li> <li class=md-nav__item> <a href=../../testing-strategies/hybrid/ class=md-nav__link> Hybrid (A/B + SLOs) testing (quick start) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_2 type=checkbox id=__nav_4_3_2> <label class=md-nav__link for=__nav_4_3_2> Rollout strategies <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Rollout strategies" data-md-level=3> <label class=md-nav__title for=__nav_4_3_2> <span class="md-nav__icon md-icon"></span> Rollout strategies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../rollout-strategies/progressive/ class=md-nav__link> Progressive traffic shift </a> </li> <li class=md-nav__item> <a href=../../rollout-strategies/fixed-split/ class=md-nav__link> Fixed-%-split </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3_3 type=checkbox id=__nav_4_3_3 checked> <label class=md-nav__link for=__nav_4_3_3> GitOps <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=GitOps data-md-level=3> <label class=md-nav__title for=__nav_4_3_3> <span class="md-nav__icon md-icon"></span> GitOps </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Argo CD + Istio <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Argo CD + Istio </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#step-1-create-k8s-cluster class=md-nav__link> Step 1. Create K8s cluster </a> </li> <li class=md-nav__item> <a href=#step-2-fork-repo class=md-nav__link> Step 2. Fork repo </a> </li> <li class=md-nav__item> <a href=#step-3-install-platform-components class=md-nav__link> Step 3. Install platform components </a> </li> <li class=md-nav__item> <a href=#step-4-argo-cd-setup class=md-nav__link> Step 4. Argo CD Setup </a> </li> <li class=md-nav__item> <a href=#step-5-setup-github-token class=md-nav__link> Step 5. Setup Github token </a> </li> <li class=md-nav__item> <a href=#step-6-start-experiment class=md-nav__link> Step 6. Start experiment </a> </li> <li class=md-nav__item> <a href=#7-finish-experiment class=md-nav__link> 7. Finish experiment </a> </li> <li class=md-nav__item> <a href=#8-cleanup class=md-nav__link> 8. Cleanup </a> </li> <li class=md-nav__item> <a href=#9-additional-details class=md-nav__link> 9. Additional details </a> <nav class=md-nav aria-label="9. Additional details"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#env-repo-setup class=md-nav__link> Env repo setup </a> </li> <li class=md-nav__item> <a href=#gitops-support-for-multiple-environments class=md-nav__link> GitOps support for multiple environments </a> </li> <li class=md-nav__item> <a href=#caveats class=md-nav__link> Caveats </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Metrics <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Metrics data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Metrics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../metrics/using-metrics/ class=md-nav__link> Using metrics </a> </li> <li class=md-nav__item> <a href=../../../../metrics/builtin/ class=md-nav__link> Builtin metrics </a> </li> <li class=md-nav__item> <a href=../../../../metrics/custom/ class=md-nav__link> Custom metrics </a> </li> <li class=md-nav__item> <a href=../../../../metrics/mock/ class=md-nav__link> Mock metrics </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Reference <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Reference data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../reference/experiment/ class=md-nav__link> Experiment resource </a> </li> <li class=md-nav__item> <a href=../../../../reference/metrics/ class=md-nav__link> Metric resource </a> </li> <li class=md-nav__item> <a href=../../../../reference/tasks/ class=md-nav__link> Tasks </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_4 type=checkbox id=__nav_6_4> <label class=md-nav__link for=__nav_6_4> Task Reference <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Task Reference" data-md-level=2> <label class=md-nav__title for=__nav_6_4> <span class="md-nav__icon md-icon"></span> Task Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../reference/tasks/common/ class=md-nav__link> Common Tasks </a> </li> <li class=md-nav__item> <a href=../../../../reference/tasks/metrics/ class=md-nav__link> Metrics Tasks </a> </li> <li class=md-nav__item> <a href=../../../../reference/tasks/notification/ class=md-nav__link> Notification Tasks </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Contributing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Contributing data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Contributing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../contributing/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../../contributing/newk8sstack/ class=md-nav__link> New K8s stack </a> </li> <li class=md-nav__item> <a href=../../../../contributing/tutorials/ class=md-nav__link> Tutorials </a> </li> <li class=md-nav__item> <a href=../../../../contributing/analytics/ class=md-nav__link> Analytics </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../roadmap/ class=md-nav__link> Roadmap </a> </li> <li class=md-nav__item> <a href=../../../../news/ class=md-nav__link> News </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#step-1-create-k8s-cluster class=md-nav__link> Step 1. Create K8s cluster </a> </li> <li class=md-nav__item> <a href=#step-2-fork-repo class=md-nav__link> Step 2. Fork repo </a> </li> <li class=md-nav__item> <a href=#step-3-install-platform-components class=md-nav__link> Step 3. Install platform components </a> </li> <li class=md-nav__item> <a href=#step-4-argo-cd-setup class=md-nav__link> Step 4. Argo CD Setup </a> </li> <li class=md-nav__item> <a href=#step-5-setup-github-token class=md-nav__link> Step 5. Setup Github token </a> </li> <li class=md-nav__item> <a href=#step-6-start-experiment class=md-nav__link> Step 6. Start experiment </a> </li> <li class=md-nav__item> <a href=#7-finish-experiment class=md-nav__link> 7. Finish experiment </a> </li> <li class=md-nav__item> <a href=#8-cleanup class=md-nav__link> 8. Cleanup </a> </li> <li class=md-nav__item> <a href=#9-additional-details class=md-nav__link> 9. Additional details </a> <nav class=md-nav aria-label="9. Additional details"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#env-repo-setup class=md-nav__link> Env repo setup </a> </li> <li class=md-nav__item> <a href=#gitops-support-for-multiple-environments class=md-nav__link> GitOps support for multiple environments </a> </li> <li class=md-nav__item> <a href=#caveats class=md-nav__link> Caveats </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/iter8-tools/iter8/edit/master/mkdocs/docs/tutorials/istio/gitops/argocd.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=gitops-with-argo-cd>GitOps with Argo CD<a class=headerlink href=#gitops-with-argo-cd title="Permanent link">&para;</a></h1> <div class="admonition tip"> <p class=admonition-title>Scenario: GitOps</p> <p>GitOps methodology is being widely used in CI/CD pipelines in Kubernetes-based environments to ease cluster management tasks. When using this methodology, the desired states of one or more clusters are kept in a Git repo, and a CD pipeline tool will continuously monitor for changes in the repo and sync them to the clusters. Additionally, it is preferred that Git repos are structured in a certain way so that the code repo is separated from the environment (Env) repo. Commits to the code repo trigger the CI pipeline tool to build, test, lint, and eventually push newly built images to an image repository. The Env repo contains configuration files that describe how various resources should be deployed in the cluster. Subsequently, configurations in the Env repo are updated to point to the newly built images. And finally, the CD pipeline tool will sync the new desired states to the clusters. This process is shown below:</p> <p><img alt=CICD src=../../../../images/CICD.png></p> </div> <div class="admonition tip"> <p class=admonition-title>Scenario: Iter8+Gitops</p> <p>Iter8 can be used in the context of GitOps (shown below) so that new versions of an application can be progressively rolled out, or even rolled back when problems are detected. In this tutorial, we will use Argo CD as the CD pipeline tool and Istio as the underlying service mesh,</p> <p><img alt=CICD+Iter8 src=../../../../images/CICD%2BIter8.png></p> <p>We assume the reader has at least a basic understanding of how Iter8 works from the <a href=../../../../getting-started/quick-start/istio/platform-setup/#1-create-kubernetes-cluster>quick start tutorial</a>. Since the Env repo is at the heart of GitOps, we will focus mainly on how to setup and manage the Env repo during application update. In this tutorial, we will cover the following topics.</p> <ol> <li>How to setup an Env repo to work with Iter8+GitOps</li> <li>How to update the Env repo to start an Iter8 experiment</li> <li>How to cleanup the Env repo after an Iter8 experiment is finished</li> </ol> </div> <details class=warning open=open><summary>Iter8 GitOps Guarantees</summary><p>Unlike other progressive delivery tools, Iter8 adheres to GitOps guarantees by ensuring the desired state is always in sync with the actual state. App version that failed promotion criteria will never get promoted, even if the cluster had to be recreated from scratch. This important GitOps property is often not guaranteed by other tools!</p> </details> <h2 id=step-1-create-k8s-cluster>Step 1. Create K8s cluster<a class=headerlink href=#step-1-create-k8s-cluster title="Permanent link">&para;</a></h2> <p>If you don't already have a K8s cluster, <a href=../../../../getting-started/quick-start/istio/platform-setup/ >create a Minikube or Kind K8s cluster locally</a>.</p> <h2 id=step-2-fork-repo>Step 2. Fork repo<a class=headerlink href=#step-2-fork-repo title="Permanent link">&para;</a></h2> <p>As you will need to make changes to the Env repo to test new app versions, you will need your own copy of the repo.</p> <ul> <li>Fork this repo: <a href=https://github.com/iter8-tools/iter8>https://github.com/iter8-tools/iter8</a></li> <li>Now you should have your own Env repo at: <a href=https://github.com/[YOUR_ORG]/iter8>https://github.com/[YOUR_ORG]/iter8</a></li> </ul> <h2 id=step-3-install-platform-components>Step 3. Install platform components<a class=headerlink href=#step-3-install-platform-components title="Permanent link">&para;</a></h2> <p>In your K8s cluster, you will need to install Istio, Prometheus, Iter8, and Argo CD. Run the following script to install these:</p> <div class=highlight><pre><span></span><code>git clone https://github.com/<span class=o>[</span>YOUR_ORG<span class=o>]</span>/iter8.git
<span class=nb>cd</span> iter8
<span class=nb>export</span> <span class=nv>ITER8</span><span class=o>=</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>
<span class=nv>$ITER8</span>/samples/istio/gitops/platformsetup.sh
</code></pre></div> <p>replacing <code>[YOUR_ORG]</code> with your Github organization or username. Now, do the same replacement operation to update some references in the repo so they will point at your forked repo.</p> <div class=tabbed-set data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>MacOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>find <span class=nv>$ITER8</span>/samples/istio/gitops -name <span class=s2>&quot;*&quot;</span> -type f <span class=p>|</span> xargs sed -i <span class=s1>&#39;&#39;</span> <span class=s2>&quot;s/MY_ORG/YOUR_ORG/&quot;</span>
</code></pre></div> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>Linux</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>find <span class=nv>$ITER8</span>/samples/istio/gitops -name <span class=s2>&quot;*&quot;</span> -type f <span class=p>|</span> xargs sed -i <span class=s2>&quot;s/MY_ORG/YOUR_ORG/&quot;</span>
</code></pre></div> </div> </div> <h2 id=step-4-argo-cd-setup>Step 4. Argo CD Setup<a class=headerlink href=#step-4-argo-cd-setup title="Permanent link">&para;</a></h2> <p>The output from the previous step will provide instructions on how to access Argo CD UI to setup your Argo CD app. You might see something similar to:</p> <div class=highlight><pre><span></span><code>Your Argo CD installation is <span class=nb>complete</span>
Run the following commands:
    <span class=m>1</span>. kubectl port-forward svc/argocd-server -n argocd <span class=m>8080</span>:443
    <span class=m>2</span>. Open a browser with URL: http://localhost:8080 with the following credential
       Username: <span class=s1>&#39;admin&#39;</span>, Password: <span class=s1>&#39;xxxxxxxxxx&#39;</span>
</code></pre></div> <p>Start the port-forward in a new terminal, and access the Argo CD UI from your browser. After logging in, you should see Argo CD showing no application is currently installed. To install the bookinfo application we will use for this tutorial, run the following:</p> <div class=highlight><pre><span></span><code>kubectl apply -f <span class=nv>$ITER8</span>/samples/istio/gitops/argocd-app.yaml
</code></pre></div> <p>Now Argo CD UI should show a new app called <code>gitops</code> is created. Make sure it is showing both Healthy and Synced - this might take a few minutes.</p> <h2 id=step-5-setup-github-token>Step 5. Setup Github token<a class=headerlink href=#step-5-setup-github-token title="Permanent link">&para;</a></h2> <p>At the end of an experiment, Iter8 will need to update Env repo so the winner of the experiment becomes the new baseline (it will also need to perform various clean up tasks in the Env repo -- we will discuss these later). To accomplish this, Iter8 will need to have access to your Env repo, so it can make the necessary changes by creating PRs. First, login to <a href=http://www.github.com>www.github.com</a>, and from the upper right corner of the page, go to Settings &gt; Developer settings &gt; Personal access token &gt; Generate new token. Make sure the token is granted access for <code>repo.public_repo</code>. Now create a K8s secret from the token so that Iter8 can use it at runtime.</p> <p>Run the following (replace the token string with your own token):</p> <div class=highlight><pre><span></span><code>kubectl create secret generic iter8-token --from-literal<span class=o>=</span><span class=nv>token</span><span class=o>=</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre></div> <h2 id=step-6-start-experiment>Step 6. Start experiment<a class=headerlink href=#step-6-start-experiment title="Permanent link">&para;</a></h2> <p>When new images become available and/or new configurations need to be tested, the CI pipeline tool (or some other entity) will make changes to the Env repo, so the new desired states can be deployed into the cluster. To use Iter8 to perform progressive traffic shift, the CI pipeline tool will need to make a few additional changes in the Env repo. Specifically, it will need to create at least the following resources:</p> <ol> <li>A candidate deployment</li> <li>An Iter8 experiment</li> <li>(Optionally) A workload generator</li> </ol> <p>These are the same resources you would need to create even in an non-GitOps setting. To simplify this step in the tutorial, we included a <code>runCI.sh</code> script that creates these 3 resources.</p> <p>Run the following:</p> <div class=highlight><pre><span></span><code><span class=o>(</span><span class=nb>cd</span> <span class=nv>$ITER8</span>/samples/istio/gitops<span class=p>;</span> ./runCI.sh<span class=o>)</span>
</code></pre></div> <p>To start an Iter8 experiment, you need to commit these changes to the Env repo for Argo CD to sync them to the cluster. Run the following:</p> <div class=highlight><pre><span></span><code>git add -A .<span class=p>;</span> git commit -m <span class=s2>&quot;iter8 experiment&quot;</span><span class=p>;</span> git push origin head
</code></pre></div> <p>By default Argo CD is configured to run every 3 minutes, so if you don't want to wait, you can use Argo CD UI to force a manual refresh so the changes to the Env repo can be immediately synced to the cluster.</p> <details class=info><summary>More about runCI.sh</summary><p><code>runCI.sh</code> (shown as below) creates resource files from templates using <code>sed</code>. <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1># give fortio deployment a random name so it restarts on a new experiment</span>
<span class=nv>RANDOM</span><span class=o>=</span><span class=sb>`</span>od -An -N4 -i /dev/random<span class=sb>`</span>
sed <span class=s2>&quot;s|  name: fortio-|  name: fortio-</span><span class=nv>$RANDOM</span><span class=s2>|&quot;</span> templates/fortio.yaml &gt; ./fortio.yaml

<span class=c1># give experiment a random name so CI triggers new experiment each time a new app version is available</span>
sed <span class=s2>&quot;s|name: gitops-exp|name: gitops-exp-</span><span class=nv>$RANDOM</span><span class=s2>|&quot;</span> templates/experiment.yaml &gt; ./experiment.yaml

<span class=c1># use a random color for a new experiment candidate</span>
<span class=nb>declare</span> -a <span class=nv>colors</span><span class=o>=(</span><span class=s2>&quot;red&quot;</span> <span class=s2>&quot;orange&quot;</span> <span class=s2>&quot;blue&quot;</span> <span class=s2>&quot;green&quot;</span> <span class=s2>&quot;yellow&quot;</span> <span class=s2>&quot;violet&quot;</span> <span class=s2>&quot;brown&quot;</span><span class=o>)</span>
<span class=nv>color</span><span class=o>=</span><span class=sb>`</span>expr <span class=nv>$RANDOM</span> % <span class=si>${#</span><span class=nv>colors</span><span class=p>[@]</span><span class=si>}</span><span class=sb>`</span>
<span class=nv>version</span><span class=o>=</span><span class=sb>`</span>git rev-parse --short HEAD<span class=sb>`</span>
sed <span class=s2>&quot;s|value: COLOR|value: \&quot;</span><span class=si>${</span><span class=nv>colors</span><span class=p>[</span><span class=nv>$color</span><span class=p>]</span><span class=si>}</span><span class=s2>\&quot;|&quot;</span> templates/productpage-candidate.yaml <span class=p>|</span><span class=se>\</span>
sed <span class=s2>&quot;s|version: v.*|version: v</span><span class=nv>$version</span><span class=s2>|&quot;</span> &gt; ./productpage-candidate.yaml
</code></pre></div> </td></tr></table></p> <p>Both <code>fortio.yaml</code> and <code>experiment.yaml</code> are almost identical to their templates in the <code>templates/</code> subdirectory. The only change we made was to give it a random name because we want each new experiment to preempt any running experiment and workload generator when Argo CD syncs. We could have used a simpler <code>cp</code> command if Argo CD supported <code>generateName</code> field better. However, in its current version, it cannot correctly associate resources with <code>generateName</code> field in the Env repo with those created in the cluster, so we had to resort to using <code>sed</code>. The candidate deployment is also templated from the <code>templates/</code> subdirectory, and we simply use the current commit ID as its version and assign it a random color to use.</p> </details> <h2 id=7-finish-experiment>7. Finish experiment<a class=headerlink href=#7-finish-experiment title="Permanent link">&para;</a></h2> <p>The experiment should run for a few minutes once it starts, and one can run the following command to track its progress:</p> <div class=highlight><pre><span></span><code>watch kubectl get experiments.iter8.tools
</code></pre></div> <p>Once the experiment finishes, check <a href=https://github.com/[YOUR_ORG]/iter8/pulls>https://github.com/[YOUR_ORG]/iter8/pulls</a>. Iter8 should have created a new PR titled <code>Iter8 GitOps</code>. File diffs from the PR should show clearly what Iter8 is proposing to change in the Env repo. Regardless which version is the winner, Iter8 will always clean up the Env repo after an experiment is finished. Specifically, the files created by the CI pipeline at the start of the experiment will be deleted, i.e., experiment.yaml, fortio.yaml, and productpage-candidate.yaml, to essentially put the Env repo back to its initial state. Additionally, if the candidate met all the success criteria of the experiment, productpage.yaml will be updated to reflect the new baseline version.</p> <p>You can now merge the PR that Iter8 just created. Argo CD should detect the change and sync the cluster to the new desired states. If the experiment had succeeded, the candidate version will become the new baseline version for future experiments.</p> <details class=info><summary>More about Iter8 GitOps task</summary><p>Iter8 operating in the GitOps mode is very similar to how it works normally. One key difference is that at the end of the experiment, it will need to perform an additional step to modify the desired state of the Env repo to reflect the outcome of the experiment. This can be done by specifying a <code>finish</code> task that runs at the end of an experiment. The specific task we are using in this tutorial is written in a shell script as shown below: <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>actions</span><span class=p>:</span>
  <span class=c1># when the experiment completes, promote the winning version in the Env repo</span>
  <span class=nt>finish</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>task</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">common/exec</span>
    <span class=nt>with</span><span class=p>:</span>
      <span class=nt>cmd</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
      <span class=nt>args</span><span class=p>:</span> <span class="p p-Indicator">[</span>
             <span class=s>&quot;-c&quot;</span><span class="p p-Indicator">,</span>
             <span class=s>&quot;apt-get</span><span class=nv> </span><span class=s>install</span><span class=nv> </span><span class=s>-y</span><span class=nv> </span><span class=s>git</span><span class=nv> </span><span class=s>jq</span><span class=nv> </span><span class=s>curl;\</span>
              <span class=s>REPO=github.com/huang195/iter8;\</span>
              <span class=s>BRANCH=gitops;\</span>
              <span class=s>USER=huang195;\</span>
              <span class=s>TOKEN=`kubectl</span><span class=nv> </span><span class=s>-n</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>.namespace</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>get</span><span class=nv> </span><span class=s>secret</span><span class=nv> </span><span class=s>iter8-token</span><span class=nv> </span><span class=s>-o</span><span class=nv> </span><span class=s>json</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>jq</span><span class=nv> </span><span class=s>-r</span><span class=nv> </span><span class=s>.data.token</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>base64</span><span class=nv> </span><span class=s>-d`;\</span>
              <span class=s>git</span><span class=nv> </span><span class=s>config</span><span class=nv> </span><span class=s>--global</span><span class=nv> </span><span class=s>user.email</span><span class=nv> </span><span class=s>&#39;iter8@iter8.tools&#39;;\</span>
              <span class=s>git</span><span class=nv> </span><span class=s>config</span><span class=nv> </span><span class=s>--global</span><span class=nv> </span><span class=s>user.name</span><span class=nv> </span><span class=s>&#39;Iter8&#39;;\</span>
              <span class=s>git</span><span class=nv> </span><span class=s>clone</span><span class=nv> </span><span class=s>https://${USER}:${TOKEN}@${REPO}</span><span class=nv> </span><span class=s>--branch=${BRANCH};\</span>
              <span class=s>cd</span><span class=nv> </span><span class=s>iter8/samples/istio/gitops;\</span>
              <span class=s>TMP=`mktemp`;\</span>
              <span class=s>sed</span><span class=nv> </span><span class=s>&#39;s/candidate/stable/g&#39;</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>.filepath</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>&gt;</span><span class=nv> </span><span class=s>$TMP;\</span>
              <span class=s>mv</span><span class=nv> </span><span class=s>$TMP</span><span class=nv> </span><span class=s>productpage.yaml;\</span>
              <span class=s>rm</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>productpage-candidate.yaml;\</span>
              <span class=s>rm</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>fortio.yaml;\</span>
              <span class=s>rm</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>experiment.yaml;\</span>
              <span class=s>if</span><span class=nv> </span><span class=s>[</span><span class=nv> </span><span class=s>`git</span><span class=nv> </span><span class=s>status</span><span class=nv> </span><span class=s>-s</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>wc</span><span class=nv> </span><span class=s>-l`</span><span class=nv> </span><span class=s>!=</span><span class=nv> </span><span class=s>0</span><span class=nv> </span><span class=s>];\</span>
              <span class=s>then</span><span class=nv> </span><span class=s>\</span>
                <span class=s>git</span><span class=nv> </span><span class=s>checkout</span><span class=nv> </span><span class=s>-b</span><span class=nv> </span><span class=s>iter8_exp;\</span>
                <span class=s>git</span><span class=nv> </span><span class=s>commit</span><span class=nv> </span><span class=s>-a</span><span class=nv> </span><span class=s>-m</span><span class=nv> </span><span class=s>&#39;update</span><span class=nv> </span><span class=s>baseline&#39;;\</span>
                <span class=s>git</span><span class=nv> </span><span class=s>push</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>origin</span><span class=nv> </span><span class=s>iter8_exp;\</span>
                <span class=s>curl</span><span class=nv> </span><span class=s>-u${USER}:${TOKEN}</span><span class=nv> </span><span class=s>-XPOST</span><span class=nv> </span><span class=s>https://api.github.com/repos/iter8-tools/iter8/pulls</span><span class=nv> </span><span class=s>-s</span><span class=nv> </span><span class=s>-d</span><span class=nv> </span><span class=s>&#39;{\&quot;head\&quot;:\&quot;iter8_exp\&quot;,</span><span class=nv> </span><span class=s>\&quot;base\&quot;:\&quot;gitops\&quot;,</span><span class=nv> </span><span class=s>\&quot;body\&quot;:\&quot;update</span><span class=nv> </span><span class=s>baseline\&quot;,</span><span class=nv> </span><span class=s>\&quot;title\&quot;:\&quot;Iter8</span><span class=nv> </span><span class=s>GitOps\&quot;}&#39;;\</span>
              <span class=s>fi;\</span>
              <span class=s>kubectl</span><span class=nv> </span><span class=s>-n</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>.namespace</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>apply</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>istio-vs.yaml;\</span>
             <span class=s>&quot;</span>
            <span class="p p-Indicator">]</span>
</code></pre></div> </td></tr></table></p> <p>For prototyping, one can write these tasks as shell scripts and inline them within an Experiment CR. This makes writing these tasks efficient and easy to debug. However, the down side is it makes the Experiment CR a lot more complicated and scary to read. We are currently working to simplify this interface, so stay tuned.</p> </details> <h2 id=8-cleanup>8. Cleanup<a class=headerlink href=#8-cleanup title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code>kubectl delete -f <span class=nv>$ITER8</span>/samples/istio/gitops/
kubectl delete ns istio-system
kubectl delete ns iter8-system
kubectl delete ns argocd
</code></pre></div> <h2 id=9-additional-details>9. Additional details<a class=headerlink href=#9-additional-details title="Permanent link">&para;</a></h2> <h3 id=env-repo-setup>Env repo setup<a class=headerlink href=#env-repo-setup title="Permanent link">&para;</a></h3> <p>In GitOps, it's generally a good idea to use multiple repos separating code from environment configurations. In cases where the same repo is being used for both, one needs to be careful when configuring CI/CD pipeline tools so code changes can be differentiated from configuration changes, so that one doesn't inadvertently create infinite loops.</p> <p>The Env repo can be organized in many different ways. With tools such as Helm and Kustomize becoming widely used, it becomes even simpler for CI pipeline tools to update an Env repo to roll out new app versions. In this tutorial, we consciously decided to use the simplest directory structure (i.e., all YAML files within a single directory without subdirectories) without the use of any higher level templating tools. Adapting the basic directory structure to Helm/Kustomize should be fairly straight forward.</p> <p>When organizing the directory structure, one needs to keep in mind that the CI pipeline tool will be creating new resources in the Env repo to start an Iter8 experiment. And when the experiment finishes, Iter8 (specifically, Iter8 tasks) will delete the added resources and update the baseline version in the Env repo. In other words, the invariant here is the directory structure, which should stay the same before and after an experiment.</p> <h3 id=gitops-support-for-multiple-environments>GitOps support for multiple environments<a class=headerlink href=#gitops-support-for-multiple-environments title="Permanent link">&para;</a></h3> <p>Some users might use GitOps to manage multiple environments, e.g., dev, staging, prod, so changes can always propagate from environment to environment, minimizing the chance of defects from reaching the prod environment. In this setup, the Iter8 GitOps task would need to be modified so that Env repo changes are done at the correct places. For example, if different environments are managed by different Env repos, the task would need to make multiple git commits, one for each of the repos. This could be done all within a single task, or across multiple tasks.</p> <h3 id=caveats>Caveats<a class=headerlink href=#caveats title="Permanent link">&para;</a></h3> <ol> <li> <p>Both CI pipeline tools and Iter8 need to write to the Env repo in GitOps, and if not coordinated, race conditions could occur. In this tutorial, we assume repo changes are done via PRs, which is a common practice, so the chance of having a race condition is minimized, if not eliminated. However, other means to coordinate writes to the Env repo by different entities can be done so Iter8 can operate in fully automated pipelines.</p> </li> <li> <p>When a new app version becomes available while an experiment is still running, Iter8 will preempt the existing experiment with the new one. We currently don't support <code>test-every-commit</code> behavior by queuing new experiments, but this could be supported in the future if it turrned out to be more common than we are currently expecting.</p> </li> <li> <p>Iter8 task could fail, just like everything else. Iter8 tasks are currently <code>fail-stop</code> without retries. Please take this into account when writing Iter8 tasks and error handling code.</p> </li> </ol> </article> </div> </div> <a href=# class="md-top md-icon" title="Back to top" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> </a> </main> <!--
  Copyright (c) 2016-2021 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <!-- Link to previous and/or next page --> <nav class="md-footer__inner md-grid" aria-label=Footer> <!-- Link to previous page --> <a href=../../rollout-strategies/fixed-split/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Fixed-%-split </div> </div> </a> <!-- Link to next page --> <a href=../../../../metrics/using-metrics/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Using metrics </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <!-- Further information --> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <!-- Copyright and theme information --> <div class=md-footer-copyright> <a href=https://iter8.tools/ target=_blank rel=noopener> Iter8 is Apache 2.0 licensed, 100% open, and community driven. </a> </div> <!-- Social links --> <div class=md-footer-social> <a href=https://github.com/iter8-tools/iter8 target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://join.slack.com/t/iter8-tools/shared_invite/zt-awl2se8i-L0pZCpuHntpPejxzLicbmw target=_blank rel=noopener title=join.slack.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.instant", "navigation.sections", "navigation.tabs", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../../assets/javascripts/workers/search.b0710199.min.js", "version": {"provider": "mike"}}</script> <script src=../../../../assets/javascripts/bundle.76f349be.min.js></script> </body> </html>